{# Load the tag library #}
{% load django_bootstrap5 %}

{# Load CSS and JavaScript #}
{% bootstrap_css %}
{% bootstrap_javascript %}

<!DOCTYPE html>
<html>
  <head>
    <title class="align-self-center">Plant Calendar</title>
    <script
      src="https://unpkg.com/htmx.org@2.0.4"
      integrity="sha384-HGfztofotfshcF7+8n44JQL2oJmowVChPTg48S+jvZoztPfvwD79OC/LTtG6dMp+"
      crossorigin="anonymous"
    ></script>
  </head>
  <body>
    <header>
      <h1><a href="/">Plant Calendar PoC</a></h1>
    </header>

    <main
      id="main-page"
      class="container"
    >
      <div hx-target="this" hx-swap="outerHTML">
        <button
          hx-get="{% url 'add_plant_record' %}"
          class="btn btn-primary btn-lg"
        >
          Add record &#43;
        </button>
      </div>

      <div class="mt-2" x-target="this" hx-swap="outerHTML">
        <button
          hx-get="{% url 'add_plant' %}"
          class="btn btn-primary btn-lg"
        >
          Add Plant &#43;
        </button>
      </div>
      <hr />
      <div class="row">
        <div class="col">
          <table class="table table-striped">
            <thead>
              <tr>
                <th class="px-2">Plant Name</th>
                <th class="px-2">Fertiliser</th>
                <th class="px-2">Sun Light Condition</th>
                <th class="px-2">Plant Date</th>
                <th class="px-2">Harvest Date</th>
                <th></th>
              </tr>
            </thead>

            <tbody
              hx-trigger="load, plantTableChanged from:body, plantRecordAdded from:body, plantRecordDeleted from:body"
              hx-get="{% url 'plant_table' %}"
              hx-target="this"
              hx-indicator="#loading-spinner"
            >
              <tr id="loading-spinner">
                <td class="spinner-border" role="status">
                  <span class="visually-hidden">Loading...</span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </body>

  <div id="modal" class="modal fade">
    <div id="dialog" class="modal-dialog" hx-target="this"></div>
  </div>

  <script>
    var modal = new bootstrap.Modal(document.getElementById("modal"));

    htmx.on("htmx:afterSwap", (e) => {
      // Response targeting #dialog => show the modal
      if (e.detail.target.id == "dialog") {
        modal.show();
      }
    });

    htmx.on("htmx:beforeSwap", (e) => {
      // Empty response targeting #dialog => hide the modal
      if (e.detail.target.id == "dialog" && !e.detail.xhr.response) {
        modal.hide();
        e.detail.shouldSwap = false;
      }
    });

    // Remove dialog content after hiding
    htmx.on("hidden.bs.modal", () => {
      document.getElementById("dialog").innerHTML = "";
    });
  </script>
</html>
